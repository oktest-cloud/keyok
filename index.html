<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPMods Admin Panel (GitHub)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root { --p: #1DB954; --s: #282828; --b: #121212; --t: #FFFFFF; --ts: #B3B3B3; }
        body { font-family: 'Roboto', sans-serif; background: var(--b); color: var(--t); margin: 0; padding-bottom: 70px; }
        header { background: var(--s); padding: 15px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .container { padding: 20px; max-width: 800px; margin: 0 auto; }
        .user-item { background: var(--s); padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid var(--p); }
        .user-info strong { display: block; color: var(--p); font-size: 1.1rem; }
        .user-info span { color: var(--ts); font-size: 0.85rem; display: block; }
        input, textarea { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 6px; background: #333; border: 1px solid #444; color: #fff; box-sizing: border-box; }
        nav { position: fixed; bottom: 0; width: 100%; height: 60px; background: var(--s); display: flex; justify-content: space-around; align-items: center; }
        .nav-item { color: var(--ts); font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .nav-item.active { color: var(--p); }
        .add-btn { background: var(--p); color: #000; width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; transform: translateY(-10px); cursor: pointer; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: var(--s); padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; }
        #loading { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; color: var(--p); z-index: 3000; }
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: 0.3s; z-index: 4000; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

    <header><h1>DPMods Configuration</h1></header>
    <div id="loading"><i class="fas fa-spinner fa-spin fa-2x"></i><p id="loadMsg">Syncing with GitHub...</p></div>

    <div class="container">
        <div id="usersTab">
            <h2>User Keys</h2>
            <div id="userList"></div>
        </div>
        <div id="settingsTab" style="display:none;">
            <h2>Global Settings</h2>
            <div class="form-group">
                <label>Dialog Title</label>
                <input type="text" id="dialogTitle">
            </div>
            <div class="form-group">
                <label>Maintenance Message</label>
                <textarea id="maintenanceMsg" rows="3"></textarea>
            </div>
            <button onclick="triggerGlobalUpdate()" style="background:var(--p); width:100%; padding:10px; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">Save Global Settings</button>
        </div>
    </div>

    <nav>
        <div class="nav-item active" onclick="showTab('users')" id="nU"><i class="fas fa-users"></i><span>Users</span></div>
        <div class="add-btn" onclick="openUserModal()"><i class="fas fa-plus"></i></div>
        <div class="nav-item" onclick="showTab('settings')" id="nS"><i class="fas fa-cog"></i><span>Settings</span></div>
    </nav>

    <div id="uModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Add New User</h2>
            <input type="text" id="uName" placeholder="Username">
            <input type="text" id="uPass" placeholder="Password">
            <input type="text" id="uDev" placeholder="Device ID">
            <input type="date" id="uExp">
            <button onclick="saveUser()" style="background:var(--p); width:100%; padding:10px; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">Save User</button>
            <button onclick="closeUserModal()" style="background:none; color:#ccc; width:100%; border:none; margin-top:10px; cursor:pointer;">Cancel</button>
        </div>
    </div>

    <div id="pModal" class="modal">
        <div class="modal-content">
            <h2>Admin Password</h2>
            <p>Enter password to push changes to GitHub.</p>
            <input type="password" id="adminPass" placeholder="Password">
            <button onclick="confirmAndPush()" style="background:var(--p); width:100%; padding:10px; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">Confirm Update</button>
            <button onclick="$('pModal').style.display='none'" style="background:none; color:#ccc; width:100%; border:none; margin-top:10px; cursor:pointer;">Cancel</button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const OWNER = "oktest-cloud";
        const REPO = "keyok";
        const FILE = "key.json"; 
        const TOKEN = "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";
        const ADMIN_PWD = "dpmods";
        const API_URL = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE}`;

        let configData = { dialog_config: {}, status_config: {}, users: [] };
        let editingIndex = -1;
        const $ = id => document.getElementById(id);

        function showToast(m) { const t=$('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000); }
        function openUserModal(index = -1) {
            editingIndex = index;
            if (index > -1) {
                const u = configData.users[index];
                $('uName').value = u.username; $('uPass').value = u.password;
                $('uDev').value = u.device_id; $('uExp').value = u.expiry_date_utc;
                $('modalTitle').innerText = "Edit User";
            } else {
                $('uName').value = ''; $('uPass').value = ''; $('uDev').value = ''; $('uExp').value = '';
                $('modalTitle').innerText = "Add New User";
            }
            $('uModal').style.display='flex';
        }
        function closeUserModal() { $('uModal').style.display='none'; }
        
        function showTab(t) {
            $('usersTab').style.display = t==='users'?'block':'none';
            $('settingsTab').style.display = t==='settings'?'block':'none';
            $('nU').classList.toggle('active', t==='users');
            $('nS').classList.toggle('active', t==='settings');
        }

        async function loadData() {
            $('loading').style.display='flex';
            try {
                const res = await fetch(API_URL, { headers: { 'Authorization': `Bearer ${TOKEN}` } });
                const json = await res.json();
                configData = JSON.parse(atob(json.content));
                renderUsers();
                if(configData.dialog_config) $('dialogTitle').value = configData.dialog_config.title || "";
                if(configData.status_config) $('maintenanceMsg').value = configData.status_config.maintenance_message || "";
            } catch (e) { showToast("Load Failed from GitHub"); }
            $('loading').style.display='none';
        }

        function renderUsers() {
            const list = $('userList'); list.innerHTML = '';
            configData.users.forEach((u, i) => {
                const div = document.createElement('div'); div.className = 'user-item';
                div.innerHTML = `<div class="user-info"><strong>${u.username}</strong><span>ID: ${u.device_id} | Exp: ${u.expiry_date_utc}</span></div>
                                 <div>
                                     <button onclick="openUserModal(${i})" style="background:none; border:none; color:var(--ts); margin-right:10px; cursor:pointer;"><i class="fas fa-edit"></i></button>
                                     <button onclick="deleteUser(${i})" style="background:none; border:none; color:#FF4D4D; cursor:pointer;"><i class="fas fa-trash"></i></button>
                                 </div>`;
                list.appendChild(div);
            });
        }

        async function pushToGitHub() {
            $('loading').style.display='flex';
            $('loadMsg').innerText = "Pushing to GitHub...";
            try {
                const res = await fetch(API_URL, { headers: { 'Authorization': `Bearer ${TOKEN}` } });
                const meta = await res.json();
                const body = {
                    message: "Update via Admin Panel",
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(configData, null, 2)))),
                    sha: meta.sha
                };
                const updateRes = await fetch(API_URL, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${TOKEN}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if(updateRes.ok) showToast("GitHub Updated Successfully!");
                else throw new Error();
            } catch (e) { showToast("Save Failed!"); }
            $('loading').style.display='none';
            loadData();
        }

        function saveUser() {
            const u = { username: $('uName').value, password: $('uPass').value, device_id: $('uDev').value, expiry_date_utc: $('uExp').value };
            if(editingIndex > -1) configData.users[editingIndex] = u;
            else configData.users.push(u);
            closeUserModal(); renderUsers();
            $('pModal').style.display='flex';
        }

        function deleteUser(i) { if(confirm("Delete User?")) { configData.users.splice(i, 1); renderUsers(); $('pModal').style.display='flex'; } }
        
        function triggerGlobalUpdate() {
            if(!configData.dialog_config) configData.dialog_config = {};
            if(!configData.status_config) configData.status_config = {};
            configData.dialog_config.title = $('dialogTitle').value;
            configData.status_config.maintenance_message = $('maintenanceMsg').value;
            $('pModal').style.display='flex';
        }

        function confirmAndPush() {
            if($('adminPass').value === ADMIN_PWD) { $('pModal').style.display='none'; pushToGitHub(); $('adminPass').value=''; }
            else { showToast("Wrong Admin Password!"); }
        }

        window.onload = loadData;
    </script>
</body>
</html>

