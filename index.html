<script>
    // ====================================================================
    // CONFIGURATION (GitHub အတွက် ပြင်ဆင်ရန်)
    // ====================================================================
    const GITHUB_OWNER = "oktest-cloud";
    const GITHUB_REPO = "keyok";
    const GITHUB_FILE_PATH = "Key.json"; // ဖိုင်နာမည်စာလုံးအသေး သတိထားပါ
    const GITHUB_BRANCH = "main";
    
    // ** သင့်ရဲ့ GitHub Personal Access Token (PAT) ကို ဒီမှာထည့်ပါ **
    const GITHUB_TOKEN = "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"; 
    const ADMIN_PASSWORD = "dpmods";

    const API_URL = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`;

    // Global state
    let configData = { dialog_config: {}, status_config: {}, users: [] };
    let currentEditingUserIndex = -1;
    let currentFilter = 'all';

    const $ = id => document.getElementById(id);

    // --- Load Config Function (GitHub API version) ---
    async function loadConfig() {
        $('loading').style.display = 'flex';
        $('loading').textContent = "Loading from GitHub...";
        try {
            const response = await fetch(`${API_URL}?ref=${GITHUB_BRANCH}`, {
                headers: { 
                    'Authorization': `Bearer ${GITHUB_TOKEN}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            if (!response.ok) throw new Error(`GitHub Read Failed: ${response.statusText}`);

            const fileData = await response.json();
            // GitHub က base64 နဲ့ပြန်ပေးလို့ decode လုပ်ရပါတယ်
            const jsonContent = decodeURIComponent(escape(atob(fileData.content)));
            configData = JSON.parse(jsonContent);

            renderUsers();
            loadSettingsToForm();
            showToast('Config loaded from GitHub!', 2000);
        } catch (error) {
            showToast(`Error: ${error.message}`, 5000);
        } finally {
            $('loading').style.display = 'none';
        }
    }

    // --- Save Config Function (GitHub API version - SHA လိုအပ်သည်) ---
    async function saveConfigToGitHub() {
        $('loading').style.display = 'flex';
        $('loading').textContent = "Updating GitHub...";

        try {
            // ၁။ အရင်ဆုံး လက်ရှိဖိုင်ရဲ့ SHA ကို ယူရပါမယ်
            const getRes = await fetch(`${API_URL}?ref=${GITHUB_BRANCH}`, {
                headers: { 'Authorization': `Bearer ${GITHUB_TOKEN}` }
            });
            const getData = await getRes.json();
            const currentSha = getData.sha;

            // ၂။ Data ကို Base64 ပြောင်းပါ
            const newJsonString = JSON.stringify(configData, null, 2);
            const base64Content = btoa(unescape(encodeURIComponent(newJsonString)));

            // ၃။ GitHub ဆီ PUT method နဲ့ ပို့ပါ
            const response = await fetch(API_URL, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: "Config updated via Admin Panel",
                    content: base64Content,
                    sha: currentSha, // ဒီ SHA ပါမှ GitHub က လက်ခံတာပါ
                    branch: GITHUB_BRANCH
                })
            });

            if (!response.ok) throw new Error("GitHub Update Failed");

            showToast('Saved to GitHub successfully!', 5000);
        } catch (error) {
            showToast(`Save Failed: ${error.message}`, 8000);
        } finally {
            $('loading').style.display = 'none';
            loadConfig(); // အချက်အလက်အသစ် ပြန်ဆွဲပါ
        }
    }

    // Password Confirm ဖြစ်ရင် GitLab အစား GitHub function ကို ခေါ်ပါ
    function handlePasswordConfirmation() {
        const inputPassword = $('adminPasswordInput').value;
        $('adminPasswordInput').value = '';
        if (inputPassword === ADMIN_PASSWORD) {
            $('passwordModal').style.display = 'none';
            saveConfigToGitHub(); // ဒီနေရာကို ပြောင်းလိုက်ပါပြီ
        } else {
            showToast('Incorrect Password.', 3000);
        }
    }

    // --- ကျန်တဲ့ UI Logic တွေကတော့ အရင်အတိုင်းပဲ ဆက်သုံးလို့ရပါတယ် ---
    // (renderUsers, showTab, etc. အားလုံး အရင်အတိုင်း ထားလိုက်ပါ)
</script>

